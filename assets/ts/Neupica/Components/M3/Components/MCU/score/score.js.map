{"version":3,"file":"score.js","sourceRoot":"","sources":["../../score/score.ts"],"names":[],"mappings":"AAAA;;;;;;;;;;;;;;;GAeG;AAEH,OAAO,EAAC,KAAK,EAAC,MAAM,cAAc,CAAC;AACnC,OAAO,KAAK,KAAK,MAAM,sBAAsB,CAAC;AAC9C,OAAO,KAAK,IAAI,MAAM,qBAAqB,CAAC;AAE5C;;;;;;;GAOG;AACH,MAAM,OAAO,KAAK;IAShB,gBAAuB,CAAC;IAExB;;;;;;;;;;;OAWG;IACH,MAAM,CAAC,KAAK,CAAC,kBAAuC,EAAE,YAAY,GAAG,KAAK;QAExE,2CAA2C;QAC3C,IAAI,aAAa,GAAG,CAAC,CAAC;QACtB,KAAK,MAAM,UAAU,IAAI,kBAAkB,CAAC,MAAM,EAAE,EAAE;YACpD,aAAa,IAAI,UAAU,CAAC;SAC7B;QAGD,0EAA0E;QAC1E,yEAAyE;QACzE,sDAAsD;QACtD,MAAM,kBAAkB,GAAG,IAAI,GAAG,EAAkB,CAAC;QACrD,MAAM,WAAW,GAAG,IAAI,GAAG,EAAiB,CAAC;QAC7C,MAAM,cAAc,GAAG,IAAI,KAAK,CAAS,GAAG,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;QACtD,KAAK,MAAM,CAAC,KAAK,EAAE,UAAU,CAAC,IAAI,kBAAkB,CAAC,OAAO,EAAE,EAAE;YAC9D,MAAM,UAAU,GAAG,UAAU,GAAG,aAAa,CAAC;YAC9C,kBAAkB,CAAC,GAAG,CAAC,KAAK,EAAE,UAAU,CAAC,CAAC;YAE1C,MAAM,GAAG,GAAG,KAAK,CAAC,OAAO,CAAC,KAAK,CAAC,CAAC;YACjC,WAAW,CAAC,GAAG,CAAC,KAAK,EAAE,GAAG,CAAC,CAAC;YAE5B,MAAM,GAAG,GAAG,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;YAChC,cAAc,CAAC,GAAG,CAAC,IAAI,UAAU,CAAC;SACnC;QAED,2EAA2E;QAC3E,uCAAuC;QACvC,MAAM,yBAAyB,GAAG,IAAI,GAAG,EAAkB,CAAC;QAC5D,KAAK,MAAM,CAAC,KAAK,EAAE,GAAG,CAAC,IAAI,WAAW,CAAC,OAAO,EAAE,EAAE;YAChD,MAAM,GAAG,GAAG,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;YAEhC,IAAI,iBAAiB,GAAG,CAAC,CAAC;YAC1B,KAAK,IAAI,CAAC,GAAG,CAAC,GAAG,GAAG,EAAE,CAAC,EAAE,CAAC,GAAG,CAAC,GAAG,GAAG,EAAE,CAAC,EAAE,CAAC,EAAE,EAAE;gBAC5C,MAAM,WAAW,GAAG,IAAI,CAAC,kBAAkB,CAAC,CAAC,CAAC,CAAC;gBAC/C,iBAAiB,IAAI,cAAc,CAAC,WAAW,CAAC,CAAC;aAClD;YACD,yBAAyB,CAAC,GAAG,CAAC,KAAK,EAAE,iBAAiB,CAAC,CAAC;SACzD;QAED,2EAA2E;QAC3E,MAAM,aAAa,GAAG,IAAI,GAAG,EAAkB,CAAC;QAChD,KAAK,MAAM,CAAC,KAAK,EAAE,GAAG,CAAC,IAAI,WAAW,CAAC,OAAO,EAAE,EAAE;YAChD,MAAM,UAAU,GAAG,yBAAyB,CAAC,GAAG,CAAC,KAAK,CAAE,CAAC;YACzD,MAAM,eAAe,GAAG,UAAU,GAAG,KAAK,GAAG,KAAK,CAAC,iBAAiB,CAAC;YAErE,MAAM,YAAY,GAAG,GAAG,CAAC,MAAM,GAAG,KAAK,CAAC,aAAa,CAAC,CAAC;gBACnD,KAAK,CAAC,mBAAmB,CAAC,CAAC;gBAC3B,KAAK,CAAC,mBAAmB,CAAC;YAC9B,MAAM,WAAW,GAAG,CAAC,GAAG,CAAC,MAAM,GAAG,KAAK,CAAC,aAAa,CAAC,GAAG,YAAY,CAAC;YAEtE,MAAM,KAAK,GAAG,eAAe,GAAG,WAAW,CAAC;YAC5C,aAAa,CAAC,GAAG,CAAC,KAAK,EAAE,KAAK,CAAC,CAAC;SACjC;QAED,0EAA0E;QAC1E,oDAAoD;QACpD,MAAM,cAAc,GAAG,YAAY,CAAC,CAAC;YACjC,KAAK,CAAC,aAAa,CAAC,WAAW,CAAC,CAAC,CAAC;YAClC,KAAK,CAAC,MAAM,CAAC,yBAAyB,EAAE,WAAW,CAAC,CAAC;QACzD,MAAM,oBAAoB,GAAG,IAAI,GAAG,EAAkB,CAAC;QACvD,KAAK,MAAM,KAAK,IAAI,cAAc,EAAE;YAClC,IAAI,YAAY,GAAG,KAAK,CAAC;YACzB,MAAM,GAAG,GAAG,WAAW,CAAC,GAAG,CAAC,KAAK,CAAE,CAAC,GAAG,CAAC;YACxC,KAAK,MAAM,CAAC,kBAAkB,EAAG,IAAI,oBAAoB,EAAE;gBACzD,MAAM,gBAAgB,GAAG,WAAW,CAAC,GAAG,CAAC,kBAAkB,CAAE,CAAC,GAAG,CAAC;gBAClE,IAAI,IAAI,CAAC,iBAAiB,CAAC,GAAG,EAAE,gBAAgB,CAAC,GAAG,EAAE,EAAE;oBACtD,YAAY,GAAG,IAAI,CAAC;oBACpB,MAAM;iBACP;aACF;YACD,IAAI,YAAY,EAAE;gBAChB,SAAS;aACV;YACD,oBAAoB,CAAC,GAAG,CAAC,KAAK,EAAE,aAAa,CAAC,GAAG,CAAC,KAAK,CAAE,CAAC,CAAC;SAC5D;QAED,0EAA0E;QAC1E,iEAAiE;QACjE,MAAM,uBAAuB,GAAG,KAAK,CAAC,IAAI,CAAC,oBAAoB,CAAC,OAAO,EAAE,CAAC,CAAC;QAC3E,uBAAuB,CAAC,IAAI,CAAC,CAAC,KAAe,EAAE,MAAgB,EAAE,EAAE;YACjE,OAAO,MAAM,CAAC,CAAC,CAAC,GAAG,KAAK,CAAC,CAAC,CAAC,CAAC;QAC9B,CAAC,CAAC,CAAC;QAEH,MAAM,MAAM,GAAG,uBAAuB,CAAC,GAAG,CAAC,CAAC,KAAe,EAAE,EAAE;YAC7D,OAAO,KAAK,CAAC,CAAC,CAAC,CAAC;QAClB,CAAC,CAAC,CAAC;QAEH,8CAA8C;QAC9C,IAAI,MAAM,CAAC,MAAM,KAAK,CAAC,EAAE;YACvB,MAAM,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC,CAAE,cAAc;SACzC;QACD,OAAO,MAAM,CAAC;IAChB,CAAC;IAEO,MAAM,CAAC,MAAM,CACjB,yBAA8C,EAC9C,WAA+B;QACjC,MAAM,QAAQ,GAAG,IAAI,KAAK,EAAU,CAAC;QACrC,KAAK,MAAM,CAAC,KAAK,EAAE,GAAG,CAAC,IAAI,WAAW,CAAC,OAAO,EAAE,EAAE;YAChD,MAAM,UAAU,GAAG,yBAAyB,CAAC,GAAG,CAAC,KAAK,CAAE,CAAC;YACzD,IAAI,GAAG,CAAC,MAAM,IAAI,KAAK,CAAC,aAAa;gBACjC,KAAK,CAAC,aAAa,CAAC,KAAK,CAAC,IAAI,KAAK,CAAC,WAAW;gBAC/C,UAAU,IAAI,KAAK,CAAC,yBAAyB,EAAE;gBACjD,QAAQ,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;aACtB;SACF;QACD,OAAO,QAAQ,CAAC;IAClB,CAAC;IAEO,MAAM,CAAC,aAAa,CAAC,WAA+B;QAC1D,OAAO,KAAK,CAAC,IAAI,CAAC,WAAW,CAAC,IAAI,EAAE,CAAC,CAAC;IACxC,CAAC;;AAtIuB,mBAAa,GAAG,IAAI,CAAC;AACrB,uBAAiB,GAAG,GAAG,CAAC;AACxB,yBAAmB,GAAG,GAAG,CAAC;AAC1B,yBAAmB,GAAG,GAAG,CAAC;AAC1B,mBAAa,GAAG,IAAI,CAAC;AACrB,iBAAW,GAAG,IAAI,CAAC;AACnB,+BAAyB,GAAG,IAAI,CAAC","sourcesContent":["/**\r\n * @license\r\n * Copyright 2021 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *      http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\n\r\nimport {Cam16} from '../hct/cam16';\r\nimport * as utils from '../utils/color_utils';\r\nimport * as math from '../utils/math_utils';\r\n\r\n/**\r\n *  Given a large set of colors, remove colors that are unsuitable for a UI\r\n *  theme, and rank the rest based on suitability.\r\n *\r\n *  Enables use of a high cluster count for image quantization, thus ensuring\r\n *  colors aren't muddied, while curating the high cluster count to a much\r\n *  smaller number of appropriate choices.\r\n */\r\nexport class Score {\r\n  private static readonly TARGET_CHROMA = 48.0;\r\n  private static readonly WEIGHT_PROPORTION = 0.7;\r\n  private static readonly WEIGHT_CHROMA_ABOVE = 0.3;\r\n  private static readonly WEIGHT_CHROMA_BELOW = 0.1;\r\n  private static readonly CUTOFF_CHROMA = 15.0;\r\n  private static readonly CUTOFF_TONE = 10.0;\r\n  private static readonly CUTOFF_EXCITED_PROPORTION = 0.01;\r\n\r\n  private constructor() {}\r\n\r\n  /**\r\n   * Given a map with keys of colors and values of how often the color appears,\r\n   * rank the colors based on suitability for being used for a UI theme.\r\n   *\r\n   * @param colorsToPopulation map with keys of colors and values of how often\r\n   *     the color appears, usually from a source image.\r\n   * @return Colors sorted by suitability for a UI theme. The most suitable\r\n   *     color is the first item, the least suitable is the last. There will\r\n   *     always be at least one color returned. If all the input colors\r\n   *     were not suitable for a theme, a default fallback color will be\r\n   *     provided, Google Blue.\r\n   */\r\n  static score(colorsToPopulation: Map<number, number>, contentColor = false):\r\n      number[] {\r\n    // Determine the total count of all colors.\r\n    let populationSum = 0;\r\n    for (const population of colorsToPopulation.values()) {\r\n      populationSum += population;\r\n    }\r\n\r\n\r\n    // Turn the count of each color into a proportion by dividing by the total\r\n    // count. Also, fill a cache of CAM16 colors representing each color, and\r\n    // record the proportion of colors for each CAM16 hue.\r\n    const colorsToProportion = new Map<number, number>();\r\n    const colorsToCam = new Map<number, Cam16>();\r\n    const hueProportions = new Array<number>(360).fill(0);\r\n    for (const [color, population] of colorsToPopulation.entries()) {\r\n      const proportion = population / populationSum;\r\n      colorsToProportion.set(color, proportion);\r\n\r\n      const cam = Cam16.fromInt(color);\r\n      colorsToCam.set(color, cam);\r\n\r\n      const hue = Math.round(cam.hue);\r\n      hueProportions[hue] += proportion;\r\n    }\r\n\r\n    // Determine the proportion of the colors around each color, by summing the\r\n    // proportions around each color's hue.\r\n    const colorsToExcitedProportion = new Map<number, number>();\r\n    for (const [color, cam] of colorsToCam.entries()) {\r\n      const hue = Math.round(cam.hue);\r\n\r\n      let excitedProportion = 0;\r\n      for (let i = (hue - 15); i < (hue + 15); i++) {\r\n        const neighborHue = math.sanitizeDegreesInt(i);\r\n        excitedProportion += hueProportions[neighborHue];\r\n      }\r\n      colorsToExcitedProportion.set(color, excitedProportion);\r\n    }\r\n\r\n    // Score the colors by their proportion, as well as how chromatic they are.\r\n    const colorsToScore = new Map<number, number>();\r\n    for (const [color, cam] of colorsToCam.entries()) {\r\n      const proportion = colorsToExcitedProportion.get(color)!;\r\n      const proportionScore = proportion * 100.0 * Score.WEIGHT_PROPORTION;\r\n\r\n      const chromaWeight = cam.chroma < Score.TARGET_CHROMA ?\r\n          Score.WEIGHT_CHROMA_BELOW :\r\n          Score.WEIGHT_CHROMA_ABOVE;\r\n      const chromaScore = (cam.chroma - Score.TARGET_CHROMA) * chromaWeight;\r\n\r\n      const score = proportionScore + chromaScore;\r\n      colorsToScore.set(color, score);\r\n    }\r\n\r\n    // Remove colors that are unsuitable, ex. very dark or unchromatic colors.\r\n    // Also, remove colors that are very similar in hue.\r\n    const filteredColors = contentColor ?\r\n        Score.filterContent(colorsToCam) :\r\n        Score.filter(colorsToExcitedProportion, colorsToCam);\r\n    const dedupedColorsToScore = new Map<number, number>();\r\n    for (const color of filteredColors) {\r\n      let duplicateHue = false;\r\n      const hue = colorsToCam.get(color)!.hue;\r\n      for (const [alreadyChosenColor, ] of dedupedColorsToScore) {\r\n        const alreadyChosenHue = colorsToCam.get(alreadyChosenColor)!.hue;\r\n        if (math.differenceDegrees(hue, alreadyChosenHue) < 15) {\r\n          duplicateHue = true;\r\n          break;\r\n        }\r\n      }\r\n      if (duplicateHue) {\r\n        continue;\r\n      }\r\n      dedupedColorsToScore.set(color, colorsToScore.get(color)!);\r\n    }\r\n\r\n    // Ensure the list of colors returned is sorted such that the first in the\r\n    // list is the most suitable, and the last is the least suitable.\r\n    const colorsByScoreDescending = Array.from(dedupedColorsToScore.entries());\r\n    colorsByScoreDescending.sort((first: number[], second: number[]) => {\r\n      return second[1] - first[1];\r\n    });\r\n\r\n    const answer = colorsByScoreDescending.map((entry: number[]) => {\r\n      return entry[0];\r\n    });\r\n\r\n    // Ensure that at least one color is returned.\r\n    if (answer.length === 0) {\r\n      answer.push(0xff4285F4);  // Google Blue\r\n    }\r\n    return answer;\r\n  }\r\n\r\n  private static filter(\r\n      colorsToExcitedProportion: Map<number, number>,\r\n      colorsToCam: Map<number, Cam16>): number[] {\r\n    const filtered = new Array<number>();\r\n    for (const [color, cam] of colorsToCam.entries()) {\r\n      const proportion = colorsToExcitedProportion.get(color)!;\r\n      if (cam.chroma >= Score.CUTOFF_CHROMA &&\r\n          utils.lstarFromArgb(color) >= Score.CUTOFF_TONE &&\r\n          proportion >= Score.CUTOFF_EXCITED_PROPORTION) {\r\n        filtered.push(color);\r\n      }\r\n    }\r\n    return filtered;\r\n  }\r\n\r\n  private static filterContent(colorsToCam: Map<number, Cam16>): number[] {\r\n    return Array.from(colorsToCam.keys());\r\n  }\r\n}\r\n"]}